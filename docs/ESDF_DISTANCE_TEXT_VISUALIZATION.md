# ESDF 距离值文本可视化

## 🎯 功能说明

在 ESDF 地图的每个栅格中显示具体的距离值（单位：米），方便验证 ESDF 计算是否正确。

---

## 🎨 显示效果

### 放大后的效果

当你放大地图到足够大时，每个栅格中会显示距离值：

```
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│  1.5    │  1.3    │  1.1    │  1.0    │  0.9    │  ← 蓝色/青色区域
├─────────┼─────────┼─────────┼─────────┼─────────┤
│  1.2    │  1.0    │  0.8    │  0.7    │  0.6    │  ← 绿色区域
├─────────┼─────────┼─────────┼─────────┼─────────┤
│  0.9    │  0.7    │  0.50   │  0.40   │  0.30   │  ← 黄色区域
├─────────┼─────────┼─────────┼─────────┼─────────┤
│  0.6    │  0.4    │  0.20   │  0.10   │  OBS    │  ← 橙色/红色区域
├─────────┼─────────┼─────────┼─────────┼─────────┤
│  0.5    │  0.3    │  0.15   │  OBS    │  OBS    │  ← 障碍物
└─────────┴─────────┴─────────┴─────────┴─────────┘
```

### 文本格式

- **距离 < 0.01m**：显示 "OBS"（障碍物）
- **距离 < 1.0m**：显示两位小数，如 "0.50"
- **距离 >= 1.0m**：显示一位小数，如 "1.5"

### 文本颜色

- **亮色背景**（黄色、绿色、青色、蓝色）：使用**黑色文字**
- **暗色背景**（深红色、红色、橙色）：使用**白色文字**

自动根据背景亮度选择，确保文字清晰可读。

---

## 🔧 技术实现

### 显示条件

```cpp
// 只有当格子足够大时才绘制文本（避免文字重叠）
if (cell_width > 30.0f && cell_height > 20.0f) {
  // 绘制距离值
}
```

**说明**：
- 需要放大地图，使每个栅格的屏幕尺寸 > 30×20 像素
- 避免在缩小视图时文字重叠

### 文本格式化

```cpp
char dist_text[16];
if (distance < 0.01) {
  snprintf(dist_text, sizeof(dist_text), "OBS");
} else if (distance < 1.0) {
  snprintf(dist_text, sizeof(dist_text), "%.2f", distance);  // 两位小数
} else {
  snprintf(dist_text, sizeof(dist_text), "%.1f", distance);  // 一位小数
}
```

### 文本居中

```cpp
// 计算文本位置（格子中心）
ImVec2 text_pos(
  (p1.x + p2.x) * 0.5f,
  (p1.y + p2.y) * 0.5f
);

// 计算文本大小以居中
ImVec2 text_size = ImGui::CalcTextSize(dist_text);
text_pos.x -= text_size.x * 0.5f;
text_pos.y -= text_size.y * 0.5f;
```

### 文本颜色选择

```cpp
// 使用亮度公式：Y = 0.299*R + 0.587*G + 0.114*B
float brightness = 0.299f * r + 0.587f * g + 0.114f * b;
uint32_t text_color = brightness > 128 ? IM_COL32(0, 0, 0, 255) : IM_COL32(255, 255, 255, 255);
```

**说明**：
- 使用标准的亮度计算公式（ITU-R BT.601）
- 亮度 > 128：使用黑色文字
- 亮度 <= 128：使用白色文字

---

## 📊 使用方法

### 1. 启动 NavSim

```bash
cd /home/gao/workspace/pnc_project/ahrs-simulator/navsim-local
./build_with_visualization.sh
```

### 2. 启用 ESDF 可视化

在 Legend 面板中勾选 "Show ESDF Map"

### 3. 放大地图

使用鼠标滚轮或触控板放大地图，直到每个栅格足够大（> 30×20 像素）

### 4. 查看距离值

现在每个栅格中会显示具体的距离值：

- **"OBS"**：障碍物（距离 ≈ 0）
- **"0.10"**：距离障碍物 0.1 米
- **"0.50"**：距离障碍物 0.5 米
- **"1.5"**：距离障碍物 1.5 米
- **"3.2"**：距离障碍物 3.2 米

### 5. 验证计算正确性

检查以下几点：

1. **障碍物位置**：应该显示 "OBS"
2. **相邻格子**：距离应该约等于 `resolution`（默认 0.1m）
3. **距离递增**：离障碍物越远，数值越大
4. **对称性**：障碍物周围的距离应该对称分布

---

## 🔍 验证示例

### 示例 1：单个障碍物

假设有一个障碍物在中心，分辨率 0.1m：

```
┌──────┬──────┬──────┬──────┬──────┐
│ 0.28 │ 0.22 │ 0.20 │ 0.22 │ 0.28 │
├──────┼──────┼──────┼──────┼──────┤
│ 0.22 │ 0.14 │ 0.10 │ 0.14 │ 0.22 │
├──────┼──────┼──────┼──────┼──────┤
│ 0.20 │ 0.10 │ OBS  │ 0.10 │ 0.20 │  ← 障碍物在中心
├──────┼──────┼──────┼──────┼──────┤
│ 0.22 │ 0.14 │ 0.10 │ 0.14 │ 0.22 │
├──────┼──────┼──────┼──────┼──────┤
│ 0.28 │ 0.22 │ 0.20 │ 0.22 │ 0.28 │
└──────┴──────┴──────┴──────┴──────┘
```

**验证点**：
- ✅ 中心是 "OBS"
- ✅ 上下左右相邻格子是 0.10m（1 格距离）
- ✅ 对角相邻格子是 0.14m（√2 格距离）
- ✅ 距离对称分布

### 示例 2：多个障碍物

```
┌──────┬──────┬──────┬──────┬──────┐
│ 0.20 │ 0.10 │ OBS  │ 0.10 │ 0.20 │  ← 上方障碍物
├──────┼──────┼──────┼──────┼──────┤
│ 0.40 │ 0.30 │ 0.20 │ 0.30 │ 0.40 │
├──────┼──────┼──────┼──────┼──────┤
│ 0.60 │ 0.50 │ 0.40 │ 0.50 │ 0.60 │
├──────┼──────┼──────┼──────┼──────┤
│ 0.40 │ 0.30 │ 0.20 │ 0.30 │ 0.40 │
├──────┼──────┼──────┼──────┼──────┤
│ 0.20 │ 0.10 │ OBS  │ 0.10 │ 0.20 │  ← 下方障碍物
└──────┴──────┴──────┴──────┴──────┘
```

**验证点**：
- ✅ 两个障碍物位置都是 "OBS"
- ✅ 中间区域的距离是到最近障碍物的距离
- ✅ 距离值平滑过渡

---

## 🐛 常见问题

### Q1: 看不到距离值文本

**原因**：地图缩放不够大

**解决**：
1. 使用鼠标滚轮放大地图
2. 确保每个栅格的屏幕尺寸 > 30×20 像素
3. 可以尝试放大到只显示几十个栅格

### Q2: 文字重叠

**原因**：地图缩放刚好在临界值附近

**解决**：
1. 继续放大地图
2. 或者缩小地图（文字会自动隐藏）

### Q3: 文字颜色看不清

**原因**：背景颜色和文字颜色对比度不够

**解决**：
- 这种情况很少见，因为代码会自动选择黑色或白色
- 如果确实看不清，可以调整亮度阈值（当前是 128）

### Q4: 距离值不正确

**可能原因**：
1. ESDF 计算有问题（但测试已验证是正确的）
2. 可视化数据复制有问题
3. 坐标转换有问题

**调试方法**：
1. 查看控制台的 ESDF 统计信息
2. 运行 `./test_esdf_map` 验证计算
3. 检查 `esdf_builder_plugin.cpp` 中的数据复制代码

---

## 📈 性能影响

### 文本绘制开销

- **缩小视图**：无影响（不绘制文本）
- **正常视图**：无影响（不绘制文本）
- **放大视图**：轻微影响（绘制文本）

### 优化措施

1. **条件绘制**：只在格子足够大时绘制
2. **采样绘制**：根据缩放级别调整采样率
3. **距离过滤**：跳过距离太大的格子

---

## ✅ 总结

### 新增功能

- ✅ 在 ESDF 栅格中显示距离值
- ✅ 自动格式化（障碍物显示 "OBS"）
- ✅ 自动选择文字颜色（黑色/白色）
- ✅ 文本居中对齐
- ✅ 性能优化（只在放大时显示）

### 使用场景

1. **验证 ESDF 计算**：直观查看距离值是否正确
2. **调试路径规划**：了解每个位置的安全距离
3. **参数调优**：验证 `max_distance` 等参数设置

### 下一步

现在可以运行 NavSim，放大地图查看距离值，验证 ESDF 计算是否正确！

```bash
cd /home/gao/workspace/pnc_project/ahrs-simulator/navsim-local
./build_with_visualization.sh
```

---

**现在可以直观地看到每个栅格的距离值了！** 🎉

