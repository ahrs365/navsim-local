# æœ€ç»ˆå®æ–½æ£€æŸ¥æ¸…å•

> **ç‰ˆæœ¬**: v2.0  
> **æ—¥æœŸ**: 2025-01-XX  
> **çŠ¶æ€**: å·²æ ¹æ®è¯¦ç»†åé¦ˆå…¨é¢ä¿®è®¢

---

## ğŸ¯ å¿…é¡»ä¿®æ”¹çš„å…³é”®ç‚¹

### 1. âœ… æ¶ˆæ¯å‘½åç»Ÿä¸€

**é—®é¢˜**ï¼šæ–‡æ¡£ä¸­æ‰€æœ‰ "plan_update" å¿…é¡»æ”¹ä¸º "plan"

**ä¿®æ”¹ä½ç½®**ï¼š
- âœ… æ¶æ„å›¾ï¼šæœåŠ¡å™¨æ¥æ”¶ `plan`ï¼ˆä¸æ˜¯ `plan_update / ego_cmd`ï¼‰
- âœ… æ¶ˆæ¯æ ¼å¼ï¼šTopic ä¸º `room/<id>/plan`
- âœ… DoD éªŒæ”¶æ ‡å‡†ï¼šèƒ½å‘é€ `plan`ï¼ˆä¸å‘é€ `ego_cmd`ï¼‰
- âœ… Phase æ­¥éª¤ï¼šæ‰€æœ‰æåˆ° `plan_update` çš„åœ°æ–¹æ”¹ä¸º `plan`

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 2. âœ… schema_ver ä½ç½®å’Œå¤„ç†

**è¦æ±‚**ï¼š
- `schema_ver` åœ¨ `data` å†…ï¼ˆä¸æ˜¯å¤–å±‚ï¼‰
- ç¼ºå¤±æˆ–ä¸åŒ¹é…æ—¶è®°å½• **WARN** æ—¥å¿—ï¼Œå°è¯•å…¼å®¹è§£æ

**ç¤ºä¾‹**ï¼š
```json
{
  "topic": "room/demo/world_tick",
  "data": {
    "schema_ver": "1.0.0",  // åœ¨ data å†…
    "tick_id": 123456,
    ...
  }
}
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 3. âœ… URL ç»„è£…è§„åˆ™

**è¦æ±‚**ï¼š
- å‘½ä»¤è¡Œä¼ å…¥ï¼š`url`ï¼ˆå¦‚ `ws://127.0.0.1:8080/ws`ï¼‰å’Œ `room_id`ï¼ˆå¦‚ `demo`ï¼‰
- Bridge æ‹¼æ¥ï¼š`ws://host/ws?room=<room_id>`
- é¿å…é‡å¤ï¼šä¸åœ¨ topic è·¯å¾„ä¸­å†æ¬¡åŒ…å« room_id

**ä»£ç ç¤ºä¾‹**ï¼š
```cpp
void Bridge::connect(const std::string& url, const std::string& room_id) {
  impl_->room_id_ = room_id;
  impl_->ws_.setUrl(url + "?room=" + room_id);  // æ‹¼æ¥è§„åˆ™
  ...
}
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 4. âœ… å­—æ®µå•ä½ä¸€è‡´åŒ–

**è¦æ±‚**ï¼š
- **theta**ï¼šå¼§åº¦ï¼ˆradï¼‰
- **kappa**ï¼šæ›²ç‡ï¼ˆ1/mï¼‰
- **v**ï¼šæ ‡é‡é€Ÿåº¦ï¼ˆm/sï¼‰
- å»¶è¿Ÿè¡¥å¿ä½¿ç”¨æ ‡é‡ v

**è½¬æ¢ç¤ºä¾‹**ï¼š
```cpp
// JSON â†’ Protobuf
ego.twist.vx = v * cos(theta);  // ä½¿ç”¨æ ‡é‡ v
ego.twist.vy = v * sin(theta);
ego.twist.omega = v * kappa;

// å»¶è¿Ÿè¡¥å¿
double dx = v * cos(theta) * delay;  // ä½¿ç”¨æ ‡é‡ v
double dy = v * sin(theta) * delay;
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 5. âœ… plan.points å¿…é¡»å­—æ®µ

**è¦æ±‚**ï¼š
- å¿…é¡»åŒ…å«ï¼š`x, y, theta, kappa, s, t, v`ï¼ˆ7 ä¸ªå­—æ®µï¼‰
- å³ä¾¿å ä½ä¹Ÿè¦å­˜åœ¨

**JSON ç¤ºä¾‹**ï¼š
```json
{
  "points": [
    {
      "x": 2.10,
      "y": 0.70,
      "theta": 1.57,    // å¼§åº¦
      "kappa": 0.0,     // æ›²ç‡ 1/mï¼Œæš‚æ—¶å¡« 0
      "s": 0.0,         // å¼§é•¿ m
      "t": 0.0,         // æ—¶é—´ s
      "v": 0.8          // é€Ÿåº¦ m/s
    }
  ]
}
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 6. âœ… å¿ƒè·³æœºåˆ¶å†™è¿› Phase 2

**è¦æ±‚**ï¼š
- æ¯ 5s å‘é€ä¸€æ¬¡
- Topic: `room/<room_id>/control/heartbeat`
- åŒ…å«ï¼š`ws_rx, ws_tx, dropped_ticks, loop_hz, compute_ms_p50`

**å®ç°ä½ç½®**ï¼šPhase 2ï¼ˆé¿å…åç»­é—æ¼ï¼‰

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 7. âœ… é˜Ÿåˆ—ç­–ç•¥æ˜ç¡®

**è¦æ±‚**ï¼š
- **å®¹é‡**ï¼š8ï¼ˆSPSC æ— é”é˜Ÿåˆ—ï¼‰
- **å…¥é˜Ÿ**ï¼šé˜Ÿåˆ—æ»¡æ—¶è¦†ç›–æœ€æ—§å…ƒç´ ï¼Œ`dropped_ticks++`
- **å‡ºé˜Ÿ**ï¼šPlanner æ¯å›åˆåªæ¶ˆè´¹æœ€æ–°ä¸€æ¡ï¼Œè·³è¿‡ä¸­é—´å¸§

**ä»£ç ç¤ºä¾‹**ï¼š
```cpp
// å…¥é˜Ÿï¼ˆWebSocket çº¿ç¨‹ï¼‰
if (queue.full()) {
  dropped_ticks_++;  // ç»Ÿè®¡ä¸¢å¼ƒ
}
queue.push(tick);  // è¦†ç›–æœ€æ—§å…ƒç´ 

// å‡ºé˜Ÿï¼ˆPlanner çº¿ç¨‹ï¼‰
proto::WorldTick latest_tick;
while (queue.pop(latest_tick)) {
  // åªä¿ç•™æœ€æ–°ä¸€æ¡
}
// ä½¿ç”¨ latest_tick è¿›è¡Œè§„åˆ’
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 8. âœ… JSON è¾“å‡ºç²¾åº¦

**è¦æ±‚**ï¼š
- ä½¿ç”¨ double
- é¿å…ç§‘å­¦è®¡æ•°æ³•ï¼ˆè®¾ç½® `std::fixed`ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```cpp
nlohmann::json j;
j["x"] = 2.123456;
j["theta"] = 1.570796;

// è¾“å‡ºæ—¶è®¾ç½®ç²¾åº¦
std::ostringstream oss;
oss << std::fixed << std::setprecision(6);
oss << j.dump();
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## ğŸ”§ å»ºè®®ä¼˜åŒ–ï¼ˆå·²é‡‡çº³ï¼‰

### 1. âœ… æ—¥å¿—çº§åˆ«åŒºåˆ†

- **WARN**ï¼šschema_ver ä¸åŒ¹é…ã€å­—æ®µç¼ºå¤±ã€å»¶è¿Ÿ >100ms
- **ERROR**ï¼šJSON è§£æå¤±è´¥ã€ç±»å‹é”™è¯¯ã€WebSocket æ–­å¼€

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 2. âœ… compute_ms_p50 æ»‘åŠ¨çª—å£

- ä½¿ç”¨æ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼ˆæœ€è¿‘ 100 å¸§ï¼‰
- è®¡ç®—ä¸­ä½æ•°ï¼ˆp50ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```cpp
std::deque<double> compute_ms_window_;

void update_compute_ms(double ms) {
  compute_ms_window_.push_back(ms);
  if (compute_ms_window_.size() > 100) {
    compute_ms_window_.pop_front();
  }
}

double compute_ms_p50() const {
  auto sorted = compute_ms_window_;
  std::sort(sorted.begin(), sorted.end());
  return sorted[sorted.size() / 2];
}
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 3. âœ… publish(plan) æ–­çº¿å¤„ç†

- æ–­çº¿æ—¶ç›´æ¥ä¸¢å¼ƒå¹¶ç»Ÿè®¡ï¼Œä¸é˜»å¡

**ä»£ç ç¤ºä¾‹**ï¼š
```cpp
void Bridge::publish(const proto::PlanUpdate& plan) {
  if (!connected_) {
    std::cerr << "[Bridge] WARN: Not connected, dropping plan" << std::endl;
    return;  // ç›´æ¥ä¸¢å¼ƒï¼Œä¸é˜»å¡
  }
  // å‘é€ plan
  ...
}
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 4. âœ… README è¡¥å…… wss:// æ”¯æŒ

- è¯´æ˜ ixwebsocket + OpenSSL æ”¯æŒ wss://

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

### 5. âœ… obstacles å­—æ®µå ä½

- å…ˆä¿ç•™å ä½è§£æï¼Œåç»­æ‰©å±•é¿éšœæ—¶ä¸ç”¨æ”¹è§£ç å±‚

**ä»£ç ç¤ºä¾‹**ï¼š
```cpp
// è§£æ obstaclesï¼ˆå ä½ï¼‰
if (j.contains("obstacles")) {
  // æš‚æ—¶ä¸å¤„ç†ï¼Œåç»­æ‰©å±•
  // for (const auto& obs : j["obstacles"]) { ... }
}
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## ğŸ“‹ æœ€ç»ˆéªŒæ”¶æ¸…å•

åœ¨æäº¤å‰ï¼ŒåŠ¡å¿…ç¡®è®¤ï¼š

- [ ] æ‰€æœ‰ `plan_update` å·²æ”¹ä¸º `plan`
- [ ] `schema_ver` åœ¨ `data` å†…ï¼Œç¼ºå¤±æˆ–ä¸åŒ¹é…è®°å½• WARN
- [ ] URL ç»„è£…è§„åˆ™æ­£ç¡®ï¼ˆå‘½ä»¤è¡Œä¼ å…¥ url å’Œ room_idï¼ŒBridge æ‹¼æ¥ï¼‰
- [ ] å­—æ®µå•ä½ä¸€è‡´ï¼ˆtheta å¼§åº¦ï¼Œv m/sï¼Œkappa 1/mï¼‰
- [ ] plan.points åŒ…å«æ‰€æœ‰ 7 ä¸ªå¿…é¡»å­—æ®µ
- [ ] å¿ƒè·³æœºåˆ¶åœ¨ Phase 2 å®ç°
- [ ] é˜Ÿåˆ—ç­–ç•¥æ˜ç¡®ï¼ˆå®¹é‡ 8ï¼Œå…¥é˜Ÿè¦†ç›–ï¼Œå‡ºé˜Ÿå–æœ€æ–°ï¼‰
- [ ] JSON è¾“å‡ºç²¾åº¦æ­£ç¡®ï¼ˆstd::fixedï¼Œæ— ç§‘å­¦è®¡æ•°æ³•ï¼‰
- [ ] æ—¥å¿—çº§åˆ«åŒºåˆ†ï¼ˆWARN/ERRORï¼‰
- [ ] compute_ms_p50 ä½¿ç”¨æ»‘åŠ¨çª—å£
- [ ] publish(plan) æ–­çº¿æ—¶ä¸é˜»å¡
- [ ] README åŒ…å« wss:// æ”¯æŒè¯´æ˜
- [ ] obstacles å­—æ®µå ä½è§£æ

---

## ğŸš€ å¼€å§‹å®æ–½

æ‰€æœ‰å¿…é¡»ä¿®æ”¹å’Œå»ºè®®ä¼˜åŒ–å·²å…¨éƒ¨å®Œæˆï¼Œå¯ä»¥å¼€å§‹ Phase 1-5 å®æ–½ï¼

**é¢„è®¡æ—¶é—´**ï¼š5 å°æ—¶

**éªŒæ”¶æ ‡å‡†**ï¼šè§ä¸»æ–‡æ¡£ç¬¬ä¸ƒç« 

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**çŠ¶æ€**: âœ… å·²å…¨é¢ä¿®è®¢ï¼Œå¯ä»¥å¼€å§‹å®æ–½

