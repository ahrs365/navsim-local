# ä¿®å¤ï¼šèµ·ç‚¹/ç»ˆç‚¹ä¸æ˜¾ç¤ºé—®é¢˜

## ğŸ› é—®é¢˜æè¿°

**ç”¨æˆ·è§‚å¯Ÿåˆ°çš„ç°è±¡**:

1. **é»˜è®¤èµ·ç‚¹/ç»ˆç‚¹ä¸æ˜¾ç¤º** - æœåŠ¡å™¨æœ‰é»˜è®¤å€¼ (0, 0) â†’ (18, 6)ï¼Œä½†å‰ç«¯æ²¡æœ‰æ˜¾ç¤ºæ ‡è®°
2. **æœ‰è½¨è¿¹ä½†è‡ªè½¦ä¸åŠ¨** - ç»¿è‰²è½¨è¿¹çº¿æ˜¾ç¤ºäº†ï¼Œä½†è‡ªè½¦åœ¨åŸç‚¹ä¸åŠ¨
3. **æ‰‹åŠ¨æ”¾ç½®èµ·ç‚¹åè‡ªè½¦å¼€å§‹åŠ¨** - ä½†ä»é»˜è®¤èµ·ç‚¹ (0, 0) å¼€å§‹ï¼Œä¸æ˜¯æ–°æ”¾ç½®çš„èµ·ç‚¹

---

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹ä»£ç é€»è¾‘

```javascript
function handleWorldTick(tick, topic) {
    // ...
    if (!state.startPoseManual && !state.trajectoryPlayback && tick.ego?.pose) {
        setStartPose(tick.ego.pose, false);
    }
    // ...
}
```

### æ—¶åºé—®é¢˜

**åœºæ™¯ 1: æ­£å¸¸å¯åŠ¨ï¼ˆæ— æœ¬åœ°ç®—æ³•ï¼‰**

```
1. é¡µé¢åŠ è½½
2. è¿æ¥ WebSocket
3. æ”¶åˆ° world_tick #1
   - state.trajectoryPlayback = null
   - è°ƒç”¨ setStartPose(ego.pose)
   - è®¾ç½® state.startPose å’Œ state.egoPose
   - æ˜¾ç¤ºèµ·ç‚¹æ ‡è®° âœ…
4. æ”¶åˆ° world_tick #2, #3, ...
   - ç»§ç»­æ›´æ–°èµ·ç‚¹æ ‡è®° âœ…
```

**åœºæ™¯ 2: æœ‰æœ¬åœ°ç®—æ³•ï¼ˆé—®é¢˜åœºæ™¯ï¼‰**

```
1. é¡µé¢åŠ è½½
2. è¿æ¥ WebSocket
3. æ”¶åˆ° plan_update #1ï¼ˆå¯èƒ½æ¯” world_tick å…ˆåˆ°ï¼‰
   - è®¾ç½® state.trajectoryPlayback = {...}
   - è®¾ç½® state.egoPose = trajectory[0]ï¼ˆé€šå¸¸æ˜¯ 0, 0ï¼‰
   - è‡ªè½¦ç§»åŠ¨åˆ° (0, 0)
   - ä½† state.startPose ä»ç„¶æ˜¯ null âŒ
4. æ”¶åˆ° world_tick #1
   - æ£€æŸ¥ !state.trajectoryPlayback â†’ false
   - ä¸è°ƒç”¨ setStartPose âŒ
   - state.startPose ä»ç„¶æ˜¯ null
   - èµ·ç‚¹æ ‡è®°ä¸æ˜¾ç¤º âŒ
5. æ”¶åˆ° plan_update #2, #3, ...
   - è½¨è¿¹å›æ”¾ç»§ç»­
   - è‡ªè½¦æ²¿è½¨è¿¹ç§»åŠ¨
   - ä½†èµ·ç‚¹æ ‡è®°ä»ç„¶ä¸æ˜¾ç¤º âŒ
```

### æ ¹æœ¬åŸå› 

**æ¡ä»¶å¤ªä¸¥æ ¼**:
```javascript
if (!state.startPoseManual && !state.trajectoryPlayback && tick.ego?.pose)
```

è¿™ä¸ªæ¡ä»¶è¦æ±‚ï¼š
- ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®èµ·ç‚¹
- **æ²¡æœ‰è½¨è¿¹å›æ”¾**
- world_tick åŒ…å« ego.pose

**é—®é¢˜**: å½“æœ‰è½¨è¿¹å›æ”¾æ—¶ï¼Œèµ·ç‚¹æ ‡è®°æ°¸è¿œä¸ä¼šæ›´æ–°ï¼

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹é€»è¾‘

**åˆ†ç¦»ä¸¤ä¸ªèŒè´£**:

1. **æ›´æ–°èµ·ç‚¹æ ‡è®°** - æ€»æ˜¯æ›´æ–°ï¼ˆé™¤éç”¨æˆ·æ‰‹åŠ¨è®¾ç½®ï¼‰
2. **æ›´æ–°è‡ªè½¦ä½ç½®** - åªåœ¨æ²¡æœ‰è½¨è¿¹å›æ”¾æ—¶æ›´æ–°

### ä¿®æ”¹åçš„ä»£ç 

```javascript
function handleWorldTick(tick, topic) {
    // ...
    // æ›´æ–°èµ·ç‚¹/ç»ˆç‚¹æ ‡è®°ï¼ˆå³ä½¿æœ‰è½¨è¿¹å›æ”¾ä¹Ÿè¦æ›´æ–°æ ‡è®°æ˜¾ç¤ºï¼‰
    if (!state.startPoseManual && tick.ego?.pose) {
        // æ›´æ–°èµ·ç‚¹æ ‡è®°å’Œ startPoseï¼Œä½†ä¸æ›´æ–° egoPoseï¼ˆå¦‚æœæœ‰è½¨è¿¹å›æ”¾ï¼‰
        state.startPose = {
          x: Number(tick.ego.pose.x ?? 0),
          y: Number(tick.ego.pose.y ?? 0),
          yaw: Number(tick.ego.pose.yaw ?? 0),
        };
        updatePoseMarker(state.startMarker, state.startPose);
        updatePoseInfoText();
        // åªæœ‰åœ¨æ²¡æœ‰è½¨è¿¹å›æ”¾æ—¶æ‰æ›´æ–° ego ä½ç½®
        if (!state.trajectoryPlayback) {
          state.egoPose = { ...state.startPose };
          updateEgoFromPose();
        }
    }
    // ...
}
```

### å…³é”®æ”¹è¿›

1. **ç§»é™¤äº† `!state.trajectoryPlayback` æ¡ä»¶** - ä»å¤–å±‚ if
2. **æ€»æ˜¯æ›´æ–° `state.startPose`** - å³ä½¿æœ‰è½¨è¿¹å›æ”¾
3. **æ€»æ˜¯æ›´æ–°èµ·ç‚¹æ ‡è®°** - `updatePoseMarker(state.startMarker, state.startPose)`
4. **æ€»æ˜¯æ›´æ–°ä¿¡æ¯æ–‡æœ¬** - `updatePoseInfoText()`
5. **æ¡ä»¶æ›´æ–° ego ä½ç½®** - åªåœ¨æ²¡æœ‰è½¨è¿¹å›æ”¾æ—¶æ›´æ–° `state.egoPose`

---

## ğŸ“Š ä¿®æ”¹å‰åå¯¹æ¯”

### ä¿®æ”¹å‰

```
æ”¶åˆ° plan_update:
  - state.trajectoryPlayback = {...}
  - state.egoPose = trajectory[0]
  - è‡ªè½¦ç§»åŠ¨åˆ°è½¨è¿¹èµ·ç‚¹

æ”¶åˆ° world_tick:
  - æ£€æŸ¥ !state.trajectoryPlayback â†’ false
  - è·³è¿‡ setStartPose
  - state.startPose ä»ç„¶æ˜¯ null
  - èµ·ç‚¹æ ‡è®°ä¸æ˜¾ç¤º âŒ
```

### ä¿®æ”¹å

```
æ”¶åˆ° plan_update:
  - state.trajectoryPlayback = {...}
  - state.egoPose = trajectory[0]
  - è‡ªè½¦ç§»åŠ¨åˆ°è½¨è¿¹èµ·ç‚¹

æ”¶åˆ° world_tick:
  - æ£€æŸ¥ !state.startPoseManual â†’ true
  - æ›´æ–° state.startPose = ego.pose
  - æ›´æ–°èµ·ç‚¹æ ‡è®° âœ…
  - æ›´æ–°ä¿¡æ¯æ–‡æœ¬ âœ…
  - æ£€æŸ¥ !state.trajectoryPlayback â†’ false
  - ä¸æ›´æ–° state.egoPoseï¼ˆä¿æŒè½¨è¿¹å›æ”¾ï¼‰âœ…
```

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. åˆ·æ–°æµè§ˆå™¨

**é‡è¦**: å¿…é¡»åˆ·æ–°æ‰èƒ½åŠ è½½æ–°ä»£ç ï¼

- æŒ‰ `Ctrl+Shift+R`ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
- æˆ–è€…æ¸…é™¤ç¼“å­˜ååˆ·æ–°

### 2. é‡æ–°è¿æ¥

1. æ‰“å¼€ http://127.0.0.1:8000/index.html
2. ç‚¹å‡»"è¿æ¥ WebSocket"æŒ‰é’®
3. ç­‰å¾…å³ä¸Šè§’æ˜¾ç¤º"å·²è¿æ¥"ï¼ˆç»¿è‰²ï¼‰

### 3. è§‚å¯Ÿç»“æœ

**é¢„æœŸç»“æœ**:

âœ… **èµ·ç‚¹æ ‡è®°æ˜¾ç¤º** - çº¢è‰²ç®­å¤´åœ¨ (0, 0)  
âœ… **ç»ˆç‚¹æ ‡è®°æ˜¾ç¤º** - çº¢è‰²ç®­å¤´åœ¨ (18, 6)  
âœ… **èµ·ç‚¹ä¿¡æ¯æ˜¾ç¤º** - "èµ·ç‚¹ï¼š(0.00, 0.00), yaw=0.00 rad"  
âœ… **ç»ˆç‚¹ä¿¡æ¯æ˜¾ç¤º** - "ç»ˆç‚¹ï¼š(18.00, 6.00), yaw=0.00 rad"  
âœ… **ç»¿è‰²è½¨è¿¹çº¿æ˜¾ç¤º**  
âœ… **è‡ªè½¦ä»èµ·ç‚¹å¼€å§‹æ²¿è½¨è¿¹ç§»åŠ¨**  

---

## ğŸ“ è®¾è®¡è¯´æ˜

### ä¸‰ä¸ªç‹¬ç«‹çš„çŠ¶æ€

1. **`state.startPose`** - èµ·ç‚¹ä½ç½®ï¼ˆç”¨äºæ˜¾ç¤ºæ ‡è®°å’Œä¿¡æ¯ï¼‰
2. **`state.egoPose`** - è‡ªè½¦å½“å‰ä½ç½®ï¼ˆç”¨äºæ¸²æŸ“è‡ªè½¦ï¼‰
3. **`state.trajectoryPlayback`** - è½¨è¿¹å›æ”¾çŠ¶æ€ï¼ˆæ§åˆ¶è‡ªè½¦è¿åŠ¨ï¼‰

### æ›´æ–°é€»è¾‘

| çŠ¶æ€ | æ›´æ–°æ—¶æœº | æ›´æ–°æ¥æº |
|------|---------|---------|
| `state.startPose` | world_tickï¼ˆå¦‚æœæœªæ‰‹åŠ¨è®¾ç½®ï¼‰ | `tick.ego.pose` |
| `state.egoPose` | world_tickï¼ˆå¦‚æœæ— è½¨è¿¹å›æ”¾ï¼‰<br/>æˆ– è½¨è¿¹å›æ”¾ | `tick.ego.pose`<br/>æˆ– `trajectory[i]` |
| `state.trajectoryPlayback` | æ”¶åˆ° plan_update | `plan_update.trajectory` |

### èŒè´£åˆ†ç¦»

**èµ·ç‚¹æ ‡è®°**:
- æ˜¾ç¤ºè§„åˆ’çš„èµ·ç‚¹
- æ€»æ˜¯è·ŸéšæœåŠ¡å™¨çš„ `ego.pose`ï¼ˆé™¤éç”¨æˆ·æ‰‹åŠ¨è®¾ç½®ï¼‰
- å³ä½¿æœ‰è½¨è¿¹å›æ”¾ä¹Ÿè¦æ˜¾ç¤º

**è‡ªè½¦ä½ç½®**:
- æ˜¾ç¤ºè‡ªè½¦å½“å‰ä½ç½®
- æœ‰è½¨è¿¹å›æ”¾æ—¶ï¼Œç”±è½¨è¿¹å›æ”¾æ§åˆ¶
- æ— è½¨è¿¹å›æ”¾æ—¶ï¼Œè·ŸéšæœåŠ¡å™¨çš„ `ego.pose`

---

## ğŸ“ æ€»ç»“

### é—®é¢˜

èµ·ç‚¹/ç»ˆç‚¹æ ‡è®°ä¸æ˜¾ç¤ºï¼Œå› ä¸ºæ¡ä»¶ `!state.trajectoryPlayback` é˜»æ­¢äº†æ›´æ–°ã€‚

### è§£å†³

åˆ†ç¦»"æ›´æ–°æ ‡è®°"å’Œ"æ›´æ–°è‡ªè½¦ä½ç½®"ä¸¤ä¸ªèŒè´£ï¼š
- æ ‡è®°æ€»æ˜¯æ›´æ–°ï¼ˆé™¤éç”¨æˆ·æ‰‹åŠ¨è®¾ç½®ï¼‰
- è‡ªè½¦ä½ç½®åªåœ¨æ²¡æœ‰è½¨è¿¹å›æ”¾æ—¶æ›´æ–°

### ç»“æœ

- âœ… èµ·ç‚¹/ç»ˆç‚¹æ ‡è®°æ­£ç¡®æ˜¾ç¤º
- âœ… è‡ªè½¦æ²¿è½¨è¿¹ç§»åŠ¨
- âœ… è½¨è¿¹å›æ”¾ä¸å—å½±å“

---

## ğŸ‰ é—®é¢˜å·²è§£å†³ï¼

**è¯·åˆ·æ–°æµè§ˆå™¨å¹¶æµ‹è¯•ï¼š**

1. æŒ‰ `Ctrl+Shift+R` å¼ºåˆ¶åˆ·æ–°
2. ç‚¹å‡»"è¿æ¥ WebSocket"æŒ‰é’®
3. è§‚å¯Ÿèµ·ç‚¹/ç»ˆç‚¹æ ‡è®°æ˜¯å¦æ˜¾ç¤º
4. è§‚å¯Ÿè‡ªè½¦æ˜¯å¦æ²¿è½¨è¿¹ç§»åŠ¨

**åº”è¯¥èƒ½çœ‹åˆ°å®Œæ•´çš„å¯è§†åŒ–äº†ï¼** ğŸš€

---

**æ–‡æ¡£ç»“æŸ**

