# å¹³æ»‘è½¨è¿¹åˆ‡æ¢

## ğŸ” é—®é¢˜æè¿°

### é—®é¢˜ 1: è‡ªè½¦æ¨¡å‹ä¸æ˜¾ç¤º

**ç—‡çŠ¶**: ç‚¹å‡»å¼€å§‹ä»¿çœŸåï¼Œç»¿è‰²è½¨è¿¹çº¿æ˜¾ç¤ºï¼Œä½†çœ‹ä¸åˆ°è“è‰²è‡ªè½¦æ¨¡å‹

**åŸå› **: å‰ç«¯çš„ `advanceEgoAlongTrajectory()` å‡½æ•°ä»åœ¨æ¸²æŸ“å¾ªç¯ä¸­è¢«è°ƒç”¨ï¼Œå¯èƒ½è¦†ç›–äº† `state.egoPose`

---

### é—®é¢˜ 2: è½¨è¿¹æ—‹è½¬/è·³è·ƒ

**ç—‡çŠ¶**: ç»¿è‰²è½¨è¿¹çº¿è¶Šæ¥è¶ŠçŸ­ï¼Œå¹¶ä¸”åœ¨æ—‹è½¬ï¼Œä¸æ˜¯ç®€å•åœ°ç¼©çŸ­

**åŸå› **: è½¨è¿¹åˆ‡æ¢ä¸å¹³æ»‘ï¼Œå¯¼è‡´è‡ªè½¦ä½ç½®è·³è·ƒ

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ 1 çš„åŸå› 

å‰ç«¯ä»£ç ä¸­ï¼Œ`advanceEgoAlongTrajectory()` åœ¨æ¯å¸§è¢«è°ƒç”¨ï¼š

```javascript
function renderLoop() {
  requestAnimationFrame(renderLoop);
  applyDisplayTick();
  advanceEgoAlongTrajectory();  // âš ï¸ æ¯å¸§éƒ½è°ƒç”¨
  updateDynamicDraftAnimation();
  controls.update();
  renderer.render(scene, camera);
}
```

è™½ç„¶æˆ‘ä»¬åœ¨ `handleWorldTick()` ä¸­è®¾ç½®äº† `state.trajectoryPlayback = null`ï¼Œä½† `advanceEgoAlongTrajectory()` ä»ç„¶ä¼šæ£€æŸ¥å¹¶å¯èƒ½ä¿®æ”¹ `state.egoPose`ã€‚

---

### é—®é¢˜ 2 çš„åŸå› ï¼šè½¨è¿¹åˆ‡æ¢ä¸å¹³æ»‘

#### æ—¶åºå›¾ï¼š

```
æ—¶åˆ» t=0:
  æœåŠ¡å™¨: ego=(0,0)
  å‘é€: world_tick: ego=(0,0), goal=(10,0)
  
æ—¶åˆ» t=0.05:
  æœ¬åœ°ç®—æ³•æ”¶åˆ° world_tick
  è§„åˆ’è½¨è¿¹: [(0,0,t=0), (1,0,t=1), (2,0,t=2), ...]
  å‘é€: plan_update
  
æ—¶åˆ» t=0.1:
  æœåŠ¡å™¨æ”¶åˆ° plan_update
  è®¾ç½®: trajectory_start_time = now (t=0.1)
  å¼€å§‹è·Ÿè¸ªè½¨è¿¹
  
æ—¶åˆ» t=1.1:
  æœåŠ¡å™¨æ’å€¼: elapsed = 1.1 - 0.1 = 1.0s
  æŸ¥æ‰¾è½¨è¿¹ç‚¹: t=1.0 â†’ ego=(1,0)
  å‘é€: world_tick: ego=(1,0)
  
æ—¶åˆ» t=1.15:
  æœ¬åœ°ç®—æ³•æ”¶åˆ° world_tick: ego=(1,0)
  è§„åˆ’æ–°è½¨è¿¹: [(1,0,t=0), (2,0,t=1), (3,0,t=2), ...]
  å‘é€: plan_update
  
æ—¶åˆ» t=1.2:
  æœåŠ¡å™¨æ”¶åˆ°æ–° plan_update
  âš ï¸ é—®é¢˜ï¼šæ­¤æ—¶æœåŠ¡å™¨çš„ ego å·²ç»åœ¨ (1.1, 0)
  âš ï¸ ä½†æ–°è½¨è¿¹ä» (1,0,t=0) å¼€å§‹
  âš ï¸ é‡ç½® trajectory_start_time = now (t=1.2)
  âš ï¸ ä¸‹ä¸€å¸§ elapsed=0ï¼Œè‡ªè½¦è·³å› (1,0)
  
ç»“æœ: è‡ªè½¦ä» (1.1,0) è·³å› (1,0)ï¼Œäº§ç”Ÿ"æŠ–åŠ¨"
```

#### å¯è§†åŒ–ï¼š

```
æ—§è½¨è¿¹: â—â”€â”€â”€â—â”€â”€â”€â—â”€â”€â”€â—â”€â”€â”€â—â”€â”€â”€â—
        0   1   2   3   4   5

è‡ªè½¦å½“å‰ä½ç½®: 1.5 (åœ¨æ—§è½¨è¿¹ä¸Š)
              â†“
        â—â”€â”€â”€â—â”€â–²â”€â—â”€â”€â”€â—â”€â”€â”€â—â”€â”€â”€â—
        0   1 1.5 2   3   4   5

æ–°è½¨è¿¹åˆ°è¾¾: [(1,0,t=0), (2,0,t=1), ...]
            â—â”€â”€â”€â—â”€â”€â”€â—â”€â”€â”€â—â”€â”€â”€â—
            1   2   3   4   5

âŒ æ—§æ–¹æ³•ï¼šé‡ç½®æ—¶é—´ï¼Œä» t=0 å¼€å§‹
   è‡ªè½¦è·³å› (1,0)
   
âœ… æ–°æ–¹æ³•ï¼šæ‰¾åˆ°æœ€æ¥è¿‘çš„ç‚¹ï¼Œä» t=0.5 å¼€å§‹
   è‡ªè½¦å¹³æ»‘è¿‡æ¸¡åˆ°æ–°è½¨è¿¹
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ 1: ç¦ç”¨å‰ç«¯è½¨è¿¹å›æ”¾

**ä¿®æ”¹æ–‡ä»¶**: `navsim-online/web/index.html`

**ä¿®æ”¹å†…å®¹**:

```javascript
function advanceEgoAlongTrajectory() {
  // âœ… é—­ç¯æ¨¡å¼ï¼šç¦ç”¨å‰ç«¯è½¨è¿¹å›æ”¾
  // è‡ªè½¦ä½ç½®å®Œå…¨ç”±æœåŠ¡å™¨çš„ world_tick.ego.pose æ§åˆ¶
  return;
  
  // åŸä»£ç å·²æ³¨é‡Š...
}
```

**æ•ˆæœ**:
- å‰ç«¯ä¸å†è®¡ç®—è‡ªè½¦ä½ç½®
- è‡ªè½¦ä½ç½®å®Œå…¨ç”±æœåŠ¡å™¨çš„ `world_tick.ego.pose` æ§åˆ¶
- é¿å…å‰ç«¯å’ŒæœåŠ¡å™¨çš„å†²çª

---

### è§£å†³æ–¹æ¡ˆ 2: å¹³æ»‘è½¨è¿¹åˆ‡æ¢

**ä¿®æ”¹æ–‡ä»¶**: `navsim-online/server/main.py`

**æ ¸å¿ƒæ€æƒ³**: æ”¶åˆ°æ–°è½¨è¿¹æ—¶ï¼Œæ‰¾åˆ°æ–°è½¨è¿¹ä¸Šæœ€æ¥è¿‘å½“å‰è‡ªè½¦ä½ç½®çš„ç‚¹ï¼Œä»é‚£é‡Œå¼€å§‹è·Ÿè¸ª

**ç®—æ³•**:

```python
def _handle_plan_update(self, data: Dict[str, Any]) -> None:
    # ... æ¸…æ´—è½¨è¿¹ç‚¹ ...
    
    if self.current_trajectory and len(self.current_trajectory) > 0:
        # æœ‰æ—§è½¨è¿¹ï¼Œéœ€è¦å¹³æ»‘åˆ‡æ¢
        current_x = self.ego_pose["x"]
        current_y = self.ego_pose["y"]
        
        # åœ¨æ–°è½¨è¿¹ä¸Šæ‰¾åˆ°æœ€æ¥è¿‘å½“å‰ä½ç½®çš„ç‚¹
        min_dist = float('inf')
        best_idx = 0
        for idx, pt in enumerate(sanitized):
            dx = pt["x"] - current_x
            dy = pt["y"] - current_y
            dist = sqrt(dxÂ² + dyÂ²)
            if dist < min_dist:
                min_dist = dist
                best_idx = idx
        
        # è°ƒæ•´ trajectory_start_time
        # ä½¿å¾—å½“å‰æ—¶åˆ»å¯¹åº”æ–°è½¨è¿¹çš„ best_idx ç‚¹
        offset_time = sanitized[best_idx]["t"]
        self.trajectory_start_time = now - offset_time
    else:
        # ç¬¬ä¸€æ¬¡æ”¶åˆ°è½¨è¿¹ï¼Œç›´æ¥ä»å¤´å¼€å§‹
        self.trajectory_start_time = now
```

**ç¤ºä¾‹**:

```
å½“å‰è‡ªè½¦ä½ç½®: (1.5, 0)

æ–°è½¨è¿¹:
  ç‚¹ 0: (1.0, 0, t=0)  è·ç¦»=0.5
  ç‚¹ 1: (2.0, 0, t=1)  è·ç¦»=0.5
  ç‚¹ 2: (3.0, 0, t=2)  è·ç¦»=1.5
  ...

æœ€æ¥è¿‘çš„ç‚¹: ç‚¹ 0 æˆ–ç‚¹ 1ï¼ˆè·ç¦»ç›¸åŒï¼‰
é€‰æ‹©: ç‚¹ 1ï¼ˆæ›´é å‰ï¼‰

è°ƒæ•´æ—¶é—´:
  offset_time = 1.0
  trajectory_start_time = now - 1.0
  
ä¸‹ä¸€å¸§:
  elapsed = now - trajectory_start_time = 1.0
  æŸ¥æ‰¾è½¨è¿¹ç‚¹: t=1.0 â†’ (2.0, 0)
  
ç»“æœ: è‡ªè½¦ä» (1.5, 0) å¹³æ»‘è¿‡æ¸¡åˆ° (2.0, 0)
```

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼š

```
æ—¶åˆ» t=1.0: ego=(1.0, 0)
æ—¶åˆ» t=1.1: ego=(1.1, 0)  â† æ—§è½¨è¿¹
æ—¶åˆ» t=1.2: ego=(1.0, 0)  â† âŒ è·³å›ï¼æ–°è½¨è¿¹ä» t=0 å¼€å§‹
æ—¶åˆ» t=1.3: ego=(1.1, 0)
æ—¶åˆ» t=1.4: ego=(1.2, 0)
æ—¶åˆ» t=1.5: ego=(1.0, 0)  â† âŒ åˆè·³å›ï¼

ç»“æœ: è‡ªè½¦ä¸æ–­è·³è·ƒï¼Œè½¨è¿¹çœ‹èµ·æ¥åœ¨"æ—‹è½¬"
```

---

### ä¿®å¤åï¼š

```
æ—¶åˆ» t=1.0: ego=(1.0, 0)
æ—¶åˆ» t=1.1: ego=(1.1, 0)  â† æ—§è½¨è¿¹
æ—¶åˆ» t=1.2: ego=(1.2, 0)  â† âœ… å¹³æ»‘åˆ‡æ¢åˆ°æ–°è½¨è¿¹
æ—¶åˆ» t=1.3: ego=(1.3, 0)
æ—¶åˆ» t=1.4: ego=(1.4, 0)
æ—¶åˆ» t=1.5: ego=(1.5, 0)

ç»“æœ: è‡ªè½¦å¹³æ»‘å‰è¿›ï¼Œè½¨è¿¹æ­£å¸¸ç¼©çŸ­
```

---

## ğŸ” è°ƒè¯•ä¿¡æ¯

### æœåŠ¡å™¨æ—¥å¿—

ä¿®å¤åï¼ŒæœåŠ¡å™¨ä¼šè¾“å‡ºå¹³æ»‘åˆ‡æ¢ä¿¡æ¯ï¼š

```
[Room demo] Received trajectory with 50 points, duration: 5.00s
[Room demo] Smooth transition: starting from point 5/50, offset=0.50s, dist=0.023m
[Room demo] Tracking: tick=20, ego=(1.00, 0.00, 0.00), v=1.00, elapsed=1.00s
```

**è§£è¯»**:
- `starting from point 5/50`: ä»æ–°è½¨è¿¹çš„ç¬¬ 5 ä¸ªç‚¹å¼€å§‹è·Ÿè¸ª
- `offset=0.50s`: æ—¶é—´åç§» 0.5 ç§’
- `dist=0.023m`: å½“å‰ä½ç½®ä¸æ–°è½¨è¿¹æœ€è¿‘ç‚¹çš„è·ç¦»

---

### æµè§ˆå™¨æ§åˆ¶å°

ä¿®å¤åï¼Œæµè§ˆå™¨æ§åˆ¶å°ä¼šè¾“å‡ºè‡ªè½¦ä½ç½®å’Œå¯è§æ€§ï¼š

```
[Ego Update] tick=20, ego=(1.00, 0.00, 0.00), visible=true, pos=(1.00, 0.00, 0.00)
[Ego Update] tick=40, ego=(2.00, 0.00, 0.00), visible=true, pos=(2.00, 0.00, 0.00)
```

**æ£€æŸ¥**:
- `visible=true`: è‡ªè½¦æ¨¡å‹å¯è§
- `pos=(x, y, z)`: è‡ªè½¦åœ¨ 3D åœºæ™¯ä¸­çš„ä½ç½®

å¦‚æœ `visible=false`ï¼Œè¯´æ˜è‡ªè½¦æ¨¡å‹è¢«éšè—äº†ã€‚

---

## ğŸ¯ éªŒè¯æ–¹æ³•

### æ­¥éª¤ 1: å¯åŠ¨ç³»ç»Ÿ

```bash
# ç»ˆç«¯ 1
cd navsim-online
bash run_navsim.sh

# ç»ˆç«¯ 2
cd navsim-local
./build/navsim_algo ws://127.0.0.1:8080/ws demo
```

---

### æ­¥éª¤ 2: æ‰“å¼€å‰ç«¯

1. æµè§ˆå™¨è®¿é—®: `http://127.0.0.1:8000/index.html`
2. ç‚¹å‡» "è¿æ¥ WebSocket"
3. ç‚¹å‡» "Start"

---

### æ­¥éª¤ 3: è§‚å¯Ÿç°è±¡

**æ­£å¸¸ç°è±¡**:
- âœ… è“è‰²è‡ªè½¦æ¨¡å‹å¯è§
- âœ… è‡ªè½¦æ²¿ç»¿è‰²è½¨è¿¹çº¿å¹³æ»‘ç§»åŠ¨
- âœ… è½¨è¿¹çº¿é€æ¸ç¼©çŸ­ï¼ˆå› ä¸ºè‡ªè½¦æ¥è¿‘ç»ˆç‚¹ï¼‰
- âœ… è½¨è¿¹çº¿æ–¹å‘ä¿æŒä¸€è‡´ï¼ˆä¸æ—‹è½¬ï¼‰

**å¼‚å¸¸ç°è±¡**:
- âŒ è‡ªè½¦æ¨¡å‹ä¸å¯è§
- âŒ è‡ªè½¦è·³è·ƒ
- âŒ è½¨è¿¹æ—‹è½¬

---

### æ­¥éª¤ 4: æ£€æŸ¥æ—¥å¿—

**æœåŠ¡å™¨ç»ˆç«¯**:
```
[Room demo] Received trajectory with 50 points, duration: 5.00s
[Room demo] Smooth transition: starting from point 5/50, offset=0.50s, dist=0.023m
[Room demo] Tracking: tick=20, ego=(1.00, 0.00, 0.00), v=1.00, elapsed=1.00s
```

**æµè§ˆå™¨æ§åˆ¶å°** (F12):
```
[Ego Update] tick=20, ego=(1.00, 0.00, 0.00), visible=true, pos=(1.00, 0.00, 0.00)
```

---

## ğŸš€ è¿›ä¸€æ­¥ä¼˜åŒ–

### ä¼˜åŒ– 1: è½¨è¿¹æ‹¼æ¥

å½“å‰æ–¹æ³•æ˜¯æ‰¾åˆ°æœ€æ¥è¿‘çš„ç‚¹ï¼Œä½†æ›´å¥½çš„æ–¹æ³•æ˜¯**æ‹¼æ¥è½¨è¿¹**ï¼š

```python
# ä¿ç•™æ—§è½¨è¿¹çš„æœªæ‰§è¡Œéƒ¨åˆ†
remaining_old = [pt for pt in old_trajectory if pt["t"] > current_elapsed]

# æ‹¼æ¥æ–°è½¨è¿¹
combined = remaining_old + new_trajectory
```

---

### ä¼˜åŒ– 2: é™ä½è§„åˆ’é¢‘ç‡

ä¸è¦æ¯å¸§éƒ½è§„åˆ’ï¼Œè€Œæ˜¯ï¼š
- å½“å‰è½¨è¿¹å‰©ä½™æ—¶é—´ < 1s æ—¶æ‰è§„åˆ’æ–°è½¨è¿¹
- æˆ–è€…å›ºå®šé¢‘ç‡ï¼ˆä¾‹å¦‚ 5Hzï¼‰

```cpp
// åœ¨ planner.cpp ä¸­
if (remaining_time < 1.0) {
    // è§„åˆ’æ–°è½¨è¿¹
}
```

---

### ä¼˜åŒ– 3: é¢„æµ‹æ€§è§„åˆ’

è§„åˆ’æ—¶è€ƒè™‘å»¶è¿Ÿï¼Œé¢„æµ‹æœªæ¥ä½ç½®ï¼š

```cpp
// é¢„æµ‹ 100ms åçš„ä½ç½®
double predicted_x = ego_x + ego_vx * 0.1;
double predicted_y = ego_y + ego_vy * 0.1;

// ä»é¢„æµ‹ä½ç½®å¼€å§‹è§„åˆ’
```

---

## ğŸ“ æ€»ç»“

### é—®é¢˜

1. **è‡ªè½¦æ¨¡å‹ä¸æ˜¾ç¤º**: å‰ç«¯è½¨è¿¹å›æ”¾å‡½æ•°è¦†ç›–äº†è‡ªè½¦ä½ç½®
2. **è½¨è¿¹æ—‹è½¬**: è½¨è¿¹åˆ‡æ¢ä¸å¹³æ»‘ï¼Œå¯¼è‡´è‡ªè½¦è·³è·ƒ

### è§£å†³æ–¹æ¡ˆ

1. **ç¦ç”¨å‰ç«¯è½¨è¿¹å›æ”¾**: è®©æœåŠ¡å™¨å®Œå…¨æ§åˆ¶è‡ªè½¦ä½ç½®
2. **å¹³æ»‘è½¨è¿¹åˆ‡æ¢**: æ‰¾åˆ°æ–°è½¨è¿¹ä¸Šæœ€æ¥è¿‘å½“å‰ä½ç½®çš„ç‚¹ï¼Œä»é‚£é‡Œå¼€å§‹è·Ÿè¸ª

### æ•ˆæœ

- âœ… è‡ªè½¦æ¨¡å‹æ­£å¸¸æ˜¾ç¤º
- âœ… è‡ªè½¦å¹³æ»‘ç§»åŠ¨
- âœ… è½¨è¿¹æ­£å¸¸ç¼©çŸ­ï¼Œä¸æ—‹è½¬

---

**æ›´æ–°æ—¶é—´**: 2025-09-30  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•

