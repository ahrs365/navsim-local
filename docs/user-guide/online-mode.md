# åœ¨çº¿æ¨¡å¼ä½¿ç”¨æŒ‡å—

NavSim Local æ”¯æŒ**åœ¨çº¿æ¨¡å¼**ï¼Œå¯ä»¥è¿æ¥åˆ° `navsim-online` WebSocket æœåŠ¡å™¨ï¼Œå®ç°å®æ—¶ä»¿çœŸå’Œ Web å¯è§†åŒ–ã€‚

## ğŸ¯ åœ¨çº¿æ¨¡å¼ vs ç¦»çº¿æ¨¡å¼

| ç‰¹æ€§ | ç¦»çº¿æ¨¡å¼ | åœ¨çº¿æ¨¡å¼ |
|------|---------|---------|
| **å¯æ‰§è¡Œæ–‡ä»¶** | `navsim_local_debug` | `navsim_algo` |
| **åœºæ™¯æ¥æº** | JSON æ–‡ä»¶ | WebSocket æœåŠ¡å™¨ |
| **å¯è§†åŒ–** | æ§åˆ¶å°è¾“å‡º / ImGui | Web æµè§ˆå™¨ |
| **äº¤äº’æ€§** | æ—  | å®æ—¶ç¼–è¾‘åœºæ™¯ |
| **é…ç½®æ–¹å¼** | å‘½ä»¤è¡Œå‚æ•° | JSON é…ç½®æ–‡ä»¶ |
| **é€‚ç”¨åœºæ™¯** | æ‰¹é‡æµ‹è¯•ã€ç®—æ³•å¼€å‘ | å®æ—¶æ¼”ç¤ºã€è°ƒè¯• |

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      WebSocket      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web Browser    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  navsim-online   â”‚
â”‚  (å¯è§†åŒ–ç•Œé¢)    â”‚      (20Hz)         â”‚  (Python Server) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â†• WebSocket
                                              (20Hz)
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚  navsim_algo     â”‚
                                        â”‚  (C++ ç®—æ³•ç¨‹åº)  â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµ**ï¼š
1. **Web â†’ Server**: ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è®¾ç½®èµ·ç‚¹ã€ç»ˆç‚¹ã€éšœç¢ç‰©
2. **Server â†’ navsim_algo**: æœåŠ¡å™¨å‘é€ `world_tick`ï¼ˆä»¿çœŸçŠ¶æ€ï¼‰
3. **navsim_algo â†’ Server**: ç®—æ³•ç¨‹åºå‘é€ `plan_update`ï¼ˆè§„åˆ’ç»“æœï¼‰
4. **Server â†’ Web**: æœåŠ¡å™¨å¹¿æ’­æ•°æ®åˆ°æµè§ˆå™¨è¿›è¡Œå¯è§†åŒ–

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šå¯åŠ¨ navsim-online æœåŠ¡å™¨

åœ¨**æ–°ç»ˆç«¯**ä¸­ï¼š

```bash
cd navsim-online
bash run_navsim.sh
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
[2025-10-18 10:30:00] å¯åŠ¨ WebSocket æœåŠ¡: http://127.0.0.1:8080/ws
[2025-10-18 10:30:01] å¯åŠ¨é™æ€å‰ç«¯: http://127.0.0.1:8000/index.html
æŒ‰ Ctrl+C ç»“æŸä¸¤ä¸ªæœåŠ¡
```

**è¯´æ˜**ï¼š
- WebSocket æœåŠ¡è¿è¡Œåœ¨ `ws://127.0.0.1:8080/ws`
- Web ç•Œé¢è¿è¡Œåœ¨ `http://127.0.0.1:8000/index.html`

### æ­¥éª¤ 2ï¼šç¼–è¯‘ navsim_algo

åœ¨**æ–°ç»ˆç«¯**ä¸­ï¼š

```bash
cd navsim-local
mkdir -p build && cd build
cmake .. -DBUILD_PLUGINS=ON
make -j$(nproc)
```

**éªŒè¯ç¼–è¯‘**ï¼š

```bash
ls -lh navsim_algo
# åº”è¯¥çœ‹åˆ° navsim_algo å¯æ‰§è¡Œæ–‡ä»¶
```

### æ­¥éª¤ 3ï¼šå¯åŠ¨ç®—æ³•ç¨‹åº

```bash
./navsim_algo ws://127.0.0.1:8080/ws demo --config=../config/default.json
```

**å‚æ•°è¯´æ˜**ï¼š
- `ws://127.0.0.1:8080/ws` - WebSocket æœåŠ¡å™¨åœ°å€
- `demo` - æˆ¿é—´ IDï¼ˆå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ä¸åŒæˆ¿é—´ï¼‰
- `--config=../config/default.json` - é…ç½®æ–‡ä»¶è·¯å¾„

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
=== NavSim Local Algorithm ===
WebSocket URL: ws://127.0.0.1:8080/ws
Room ID: demo
Config File: ../config/default.json
===============================

Loading config from: ../config/default.json
âœ“ Primary planner: AstarPlanner
âœ“ Fallback planner: StraightLinePlanner
âœ“ Perception plugins: GridMapBuilder

Connecting to WebSocket server...
âœ“ Connected to ws://127.0.0.1:8080/ws?room=demo

Waiting for world_tick...
```

### æ­¥éª¤ 4ï¼šæ‰“å¼€ Web ç•Œé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š

```
http://127.0.0.1:8000/index.html
```

**ç•Œé¢è¯´æ˜**ï¼š

1. **è¿æ¥çŠ¶æ€**ï¼šå³ä¸Šè§’æ˜¾ç¤º WebSocket è¿æ¥çŠ¶æ€
2. **3D åœºæ™¯**ï¼šä¸­å¤®æ˜¾ç¤ºä»¿çœŸåœºæ™¯ï¼ˆåœ°é¢ã€è‡ªè½¦ã€éšœç¢ç‰©ã€è½¨è¿¹ï¼‰
3. **æ§åˆ¶é¢æ¿**ï¼šå·¦ä¾§å·¥å…·æ ï¼Œç”¨äºè®¾ç½®èµ·ç‚¹ã€ç»ˆç‚¹ã€æ·»åŠ éšœç¢ç‰©
4. **ä»¿çœŸæ§åˆ¶**ï¼šé¡¶éƒ¨æŒ‰é’®ï¼ˆå¼€å§‹ã€æš‚åœã€é‡ç½®ï¼‰

### æ­¥éª¤ 5ï¼šè¿è¡Œä»¿çœŸ

1. **è®¾ç½®èµ·ç‚¹**ï¼š
   - ç‚¹å‡»å·¦ä¾§ "æ”¾ç½®èµ·ç‚¹" æŒ‰é’®
   - åœ¨ 3D åœºæ™¯ä¸­ç‚¹å‡»è®¾ç½®ä½ç½®
   - æ‹–æ‹½é¼ æ ‡ç¡®å®šæœå‘

2. **è®¾ç½®ç»ˆç‚¹**ï¼š
   - ç‚¹å‡»å·¦ä¾§ "æ”¾ç½®ç»ˆç‚¹" æŒ‰é’®
   - åœ¨ 3D åœºæ™¯ä¸­ç‚¹å‡»è®¾ç½®ä½ç½®

3. **æ·»åŠ éšœç¢ç‰©**ï¼ˆå¯é€‰ï¼‰ï¼š
   - é€‰æ‹©éšœç¢ç‰©ç±»å‹ï¼ˆåœ†å½¢/çŸ©å½¢ï¼‰
   - ç‚¹å‡»åœºæ™¯æ”¾ç½®
   - æ‹–æ‹½ç¡®å®šå¤§å°

4. **å¼€å§‹ä»¿çœŸ**ï¼š
   - ç‚¹å‡»é¡¶éƒ¨ "â–¶ å¼€å§‹" æŒ‰é’®
   - è§‚å¯Ÿè‡ªè½¦æ²¿è§„åˆ’è½¨è¿¹ç§»åŠ¨

## âš™ï¸ é…ç½®æ–‡ä»¶

### é…ç½®æ–‡ä»¶ä½ç½®

```
navsim-local/config/default.json
```

### é…ç½®æ–‡ä»¶ç»“æ„

```json
{
  "algorithm": {
    "primary_planner": "AstarPlanner",
    "fallback_planner": "StraightLinePlanner",
    "enable_planner_fallback": true,
    "max_computation_time_ms": 25.0,
    "verbose_logging": true,
    "enable_visualization": false
  },
  "perception": {
    "preprocessing": {
      "bev_extraction": {
        "enabled": true,
        "static_obstacle_inflation": 0.2,
        "dynamic_obstacle_inflation": 0.3
      }
    },
    "plugins": [
      {
        "name": "GridMapBuilder",
        "enabled": true,
        "priority": 100,
        "params": {
          "resolution": 0.1,
          "map_width": 30.0,
          "map_height": 30.0,
          "obstacle_cost": 100,
          "inflation_radius": 0.0
        }
      }
    ]
  },
  "planning": {
    "AstarPlanner": {
      "time_step": 0.1,
      "heuristic_weight": 1.2,
      "step_size": 0.5,
      "max_iterations": 10000,
      "goal_tolerance": 0.5,
      "default_velocity": 1.5
    },
    "StraightLinePlanner": {
      "default_velocity": 1.5,
      "time_step": 0.1,
      "planning_horizon": 5.0
    }
  }
}
```

### å…³é”®é…ç½®é¡¹

#### ç®—æ³•é…ç½® (`algorithm`)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `primary_planner` | string | "AstarPlanner" | ä¸»è§„åˆ’å™¨åç§° |
| `fallback_planner` | string | "StraightLinePlanner" | é™çº§è§„åˆ’å™¨ |
| `enable_planner_fallback` | bool | true | å¯ç”¨é™çº§æœºåˆ¶ |
| `max_computation_time_ms` | double | 25.0 | æœ€å¤§è®¡ç®—æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `verbose_logging` | bool | true | è¯¦ç»†æ—¥å¿— |
| `enable_visualization` | bool | false | ImGui å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰ |

#### æ„ŸçŸ¥é…ç½® (`perception.plugins`)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `name` | string | - | æ’ä»¶åç§° |
| `enabled` | bool | true | æ˜¯å¦å¯ç”¨ |
| `priority` | int | 100 | ä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå¤§è¶Šå…ˆæ‰§è¡Œï¼‰ |
| `params` | object | {} | æ’ä»¶å‚æ•° |

#### è§„åˆ’å™¨é…ç½® (`planning.<PlannerName>`)

æ¯ä¸ªè§„åˆ’å™¨å¯ä»¥æœ‰è‡ªå·±çš„å‚æ•°é…ç½®ã€‚

**A* è§„åˆ’å™¨å‚æ•°**ï¼š

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `heuristic_weight` | double | 1.2 | å¯å‘å¼æƒé‡ï¼ˆ> 1 åŠ é€Ÿæœç´¢ï¼‰ |
| `step_size` | double | 0.5 | æœç´¢æ­¥é•¿ï¼ˆç±³ï¼‰ |
| `max_iterations` | int | 10000 | æœ€å¤§è¿­ä»£æ¬¡æ•° |
| `goal_tolerance` | double | 0.5 | ç›®æ ‡å®¹å·®ï¼ˆç±³ï¼‰ |

### ä¿®æ”¹é…ç½®

1. **ç¼–è¾‘é…ç½®æ–‡ä»¶**ï¼š

```bash
cd navsim-local/config
vim default.json
```

2. **é‡å¯ç®—æ³•ç¨‹åº**ï¼š

```bash
# æŒ‰ Ctrl+C åœæ­¢å½“å‰ç¨‹åº
# é‡æ–°å¯åŠ¨
./build/navsim_algo ws://127.0.0.1:8080/ws demo --config=config/default.json
```

**æ³¨æ„**ï¼šé…ç½®æ–‡ä»¶ä¿®æ”¹åéœ€è¦é‡å¯ `navsim_algo`ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ã€‚

## ğŸ¨ Web ç•Œé¢åŠŸèƒ½

### åœºæ™¯ç¼–è¾‘

| å·¥å…· | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| **æ”¾ç½®èµ·ç‚¹** | ç‚¹å‡» â†’ æ‹–æ‹½ | è®¾ç½®èµ·ç‚¹ä½ç½®å’Œæœå‘ |
| **æ”¾ç½®ç»ˆç‚¹** | ç‚¹å‡» â†’ æ‹–æ‹½ | è®¾ç½®ç»ˆç‚¹ä½ç½®å’Œæœå‘ |
| **é™æ€åœ†å½¢éšœç¢ç‰©** | ç‚¹å‡» â†’ æ‹–æ‹½ | è®¾ç½®åœ†å¿ƒå’ŒåŠå¾„ |
| **é™æ€çŸ©å½¢éšœç¢ç‰©** | ç‚¹å‡» â†’ æ‹–æ‹½ | è®¾ç½®ä¸­å¿ƒã€å°ºå¯¸å’Œæœå‘ |
| **åŠ¨æ€éšœç¢ç‰©** | ç‚¹å‡» â†’ æ‹–æ‹½ â†’ è¾“å…¥é€Ÿåº¦ | è®¾ç½®è¿åŠ¨éšœç¢ç‰© |

### ä»¿çœŸæ§åˆ¶

| æŒ‰é’® | åŠŸèƒ½ | å¿«æ·é”® |
|------|------|--------|
| â–¶ å¼€å§‹ | å¯åŠ¨ä»¿çœŸ | - |
| â¸ æš‚åœ | æš‚åœä»¿çœŸ | - |
| â­ å•æ­¥ | å•æ­¥æ‰§è¡Œ | - |
| ğŸ”„ é‡ç½® | é‡ç½®åœºæ™¯ | - |

### è§†å›¾æ§åˆ¶

| æ“ä½œ | åŠŸèƒ½ |
|------|------|
| **é¼ æ ‡å·¦é”®æ‹–æ‹½** | æ—‹è½¬è§†è§’ |
| **é¼ æ ‡å³é”®æ‹–æ‹½** | å¹³ç§»è§†è§’ |
| **é¼ æ ‡æ»šè½®** | ç¼©æ”¾è§†è§’ |
| **è‡ªåŠ¨è·Ÿéš** | ç›¸æœºè·Ÿéšè‡ªè½¦ |

## ğŸ”§ é«˜çº§åŠŸèƒ½

### å¯ç”¨ ImGui æ¡Œé¢å¯è§†åŒ–

åœ¨çº¿æ¨¡å¼ä¹Ÿå¯ä»¥åŒæ—¶å¯ç”¨ ImGui æ¡Œé¢å¯è§†åŒ–ï¼š

```bash
# 1. å®‰è£… SDL2
sudo apt-get install libsdl2-dev

# 2. é‡æ–°ç¼–è¯‘ï¼ˆå¯ç”¨å¯è§†åŒ–ï¼‰
cd navsim-local/build
cmake .. -DENABLE_VISUALIZATION=ON -DBUILD_PLUGINS=ON
make -j$(nproc)

# 3. ä¿®æ”¹é…ç½®æ–‡ä»¶
# ç¼–è¾‘ config/default.jsonï¼Œè®¾ç½®ï¼š
# "enable_visualization": true

# 4. è¿è¡Œ
./navsim_algo ws://127.0.0.1:8080/ws demo --config=../config/default.json
```

**æ•ˆæœ**ï¼š
- Web æµè§ˆå™¨æ˜¾ç¤º 3D åœºæ™¯
- æ¡Œé¢çª—å£æ˜¾ç¤º ImGui è°ƒè¯•ç•Œé¢ï¼ˆæ …æ ¼åœ°å›¾ã€ESDFã€å‚æ•°è°ƒèŠ‚ï¼‰

### å¤šæˆ¿é—´æ”¯æŒ

å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªç‹¬ç«‹çš„ä»¿çœŸå®ä¾‹ï¼š

```bash
# ç»ˆç«¯ 1ï¼šæˆ¿é—´ A
./navsim_algo ws://127.0.0.1:8080/ws roomA --config=../config/default.json

# ç»ˆç«¯ 2ï¼šæˆ¿é—´ B
./navsim_algo ws://127.0.0.1:8080/ws roomB --config=../config/default.json
```

åœ¨æµè§ˆå™¨ä¸­è¿æ¥ä¸åŒæˆ¿é—´ï¼š
- æˆ¿é—´ A: `http://127.0.0.1:8000/index.html?room=roomA`
- æˆ¿é—´ B: `http://127.0.0.1:8000/index.html?room=roomB`

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ— æ³•è¿æ¥åˆ° WebSocket æœåŠ¡å™¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: Failed to connect to ws://127.0.0.1:8080/ws
```

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `navsim-online` æœåŠ¡å™¨æ˜¯å¦è¿è¡Œï¼š
   ```bash
   curl http://127.0.0.1:8080/
   ```
2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
   ```bash
   lsof -i :8080
   ```
3. é‡å¯æœåŠ¡å™¨ï¼š
   ```bash
   cd navsim-online
   bash run_navsim.sh
   ```

### é—®é¢˜ 2ï¼šWeb ç•Œé¢æ— æ³•åŠ è½½

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥é™æ€æœåŠ¡å™¨æ˜¯å¦è¿è¡Œï¼š
   ```bash
   curl http://127.0.0.1:8000/index.html
   ```
2. æ‰‹åŠ¨å¯åŠ¨é™æ€æœåŠ¡å™¨ï¼š
   ```bash
   cd navsim-online/web
   python3 -m http.server 8000
   ```

### é—®é¢˜ 3ï¼šè§„åˆ’å™¨æ— å“åº”

**ç°è±¡**ï¼šè®¾ç½®èµ·ç‚¹ç»ˆç‚¹åï¼Œè‡ªè½¦ä¸ç§»åŠ¨

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `navsim_algo` æ˜¯å¦è¿è¡Œ
2. æŸ¥çœ‹ `navsim_algo` ç»ˆç«¯è¾“å‡ºæ˜¯å¦æœ‰é”™è¯¯
3. ç¡®è®¤å·²ç‚¹å‡» "â–¶ å¼€å§‹" æŒ‰é’®
4. ä½¿ç”¨ `--verbose` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

## ğŸ“š ä¸‹ä¸€æ­¥

- **è‡ªå®šä¹‰é…ç½®**ï¼šä¿®æ”¹ `config/default.json` è°ƒæ•´å‚æ•°
- **åˆ›å»ºæ’ä»¶**ï¼šæŸ¥çœ‹ [æ’ä»¶å¼€å‘æŒ‡å—](../developer-guide/plugin-development.md)
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæŸ¥çœ‹ [å¼€å‘å·¥å…·æŒ‡å—](../developer-guide/development-tools.md)

---

**é‡åˆ°é—®é¢˜ï¼Ÿ** æäº¤ [Issue](https://github.com/ahrs365/ahrs-simulator/issues)

